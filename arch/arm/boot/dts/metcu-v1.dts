// SPDX-License-Identifier: (GPL-2.0+ OR BSD-3-Clause)
/*
 * Copyright (C) STMicroelectronics 2019 - All Rights Reserved
 * Author: Alexandre Torgue <alexandre.torgue@st.com> for STMicroelectronics.
 */

/dts-v1/;

#include "stm32mp157.dtsi"
#include "stm32mp15xf.dtsi"
#include "stm32mp15-pinctrl.dtsi"
#include "stm32mp15xxac-pinctrl.dtsi"
#include "stm32mp15xx-dkx.dtsi"
#include <dt-bindings/rtc/rtc-stm32.h>

/ {
	model = "STMicroelectronics STM32MP157F-DK2 Discovery Board; METCU Adapt";
	compatible = "st,stm32mp157f-dk2", "st,stm32mp157";

	aliases {
		serial3 = &usart2;
	};

	chosen {
		#address-cells = <1>;
		#size-cells = <1>;
		ranges;
		stdout-path = "serial0:115200n8";

		framebuffer {
			compatible = "simple-framebuffer";
			clocks = <&rcc LTDC_PX>;
			status = "disabled";
		};
	};
	
	clocks {
		/* 16MHz external crystal oscillator */
		clk16m: mcp251x_osc {
			#clock-cells = <0>;
			compatible = "fixed-clock";
			clock-frequency = <16000000>;
		};
	};

	wifi_pwrseq: wifi-pwrseq {
		compatible = "mmc-pwrseq-simple";
		reset-gpios = <&gpioh 4 GPIO_ACTIVE_LOW>;
	};
};

&m_can1 {
	pinctrl-names = "default", "sleep";         /* configure pinctrl modes for m_can1 */
	pinctrl-0 = <&m_can1_pins_b>;               /* configure m_can1_pins_b as default pinctrl configuration for m_can1 */
	pinctrl-1 = <&m_can1_sleep_pins_b>;         /* configure m_can1_sleep_pins_b as sleep pinctrl configuration for m_can1 */
	status = "okay";                            /* enable m_can1 */ 
}; 

&m_can2 {
	pinctrl-names = "default", "sleep";         /* configure pinctrl modes for m_can2 */
	pinctrl-0 = <&m_can2_pins_b>;               /* configure m_can2_pins_a as default pinctrl configuration for m_can2 */
	pinctrl-1 = <&m_can2_sleep_pins_b>;         /* configure m_can2_sleep_pins_a as sleep pinctrl configuration for m_can2 */
	status = "okay";                            /* enable m_can2 */ 
}; 

&cryp1 {
	status = "okay";
};

&dsi {
	status = "okay";

	ports {
		port@0 {
			reg = <0>;
			dsi_in: endpoint {
				remote-endpoint = <&ltdc_ep1_out>;
			};
		};

		port@1 {
			reg = <1>;
			dsi_out: endpoint {
				remote-endpoint = <&panel_in>;
			};
		};
	};

	panel_otm8009a: panel-otm8009a@0 {
		compatible = "orisetech,otm8009a";
		reg = <0>;
		reset-gpios = <&gpioe 4 GPIO_ACTIVE_LOW>;
		power-supply = <&v3v3>;
		status = "okay";

		port {
			panel_in: endpoint {
				remote-endpoint = <&dsi_out>;
			};
		};
	};
};

&i2c1 {
	pinctrl-names = "default", "sleep";
	pinctrl-0 = <&i2c1_pins_a>;
	pinctrl-1 = <&i2c1_sleep_pins_a>;
	i2c-scl-rising-time-ns = <100>;
	i2c-scl-falling-time-ns = <7>;
	clock-frequency = <400000>;
	status = "okay";
};

&i2c2 {
	pinctrl-names = "default", "sleep";
	pinctrl-0 = <&i2c2_pins_d>;
	pinctrl-1 = <&i2c2_sleep_pins_d>;
	i2c-scl-rising-time-ns = <100>;
	i2c-scl-falling-time-ns = <7>;
	clock-frequency = <400000>;
	status = "okay";
};

&spi5 {
	pinctrl-names = "default", "sleep";
	pinctrl-0 = <&spi5_pins_a>;
	pinctrl-1 = <&spi5_sleep_pins_a>;
	cs-gpios = <&gpiof 6 (GPIO_ACTIVE_LOW | GPIO_PULL_UP)>, <&gpiof 3 (GPIO_ACTIVE_LOW | GPIO_PULL_UP)>;
	status = "okay";
	
	can2: can@0 {
		compatible = "microchip,mcp2515";
		reg = <0>;
		clocks = <&clk16m>;
		interrupt-parent = <&gpiog>;
		interrupts = <8 IRQ_TYPE_LEVEL_LOW>;
		vdd-supply = <&v3v3>; //SPECIFIC TO DEV BOARD AND ST PMIC
		xceiver-supply = <&vin>;  //SPECIFIC TO DEV BOARD AND ST PMIC
		gpio-controller;
		#gpio-cells = <2>;
		spi-max-frequency = <8000000>;
	};
	
	can3: can@1 {
		compatible = "microchip,mcp2515";
		reg = <1>;
		clocks = <&clk16m>;
		interrupt-parent = <&gpiod>;
		interrupts = <13 IRQ_TYPE_LEVEL_LOW>;
		vdd-supply = <&v3v3>; //SPECIFIC TO DEV BOARD AND ST PMIC
		xceiver-supply = <&vin>;  //SPECIFIC TO DEV BOARD AND ST PMIC
		gpio-controller;
		#gpio-cells = <2>;
		spi-max-frequency = <8000000>;
	};
};

&ltdc {
	status = "okay";

	port {
		ltdc_ep1_out: endpoint@1 {
			reg = <1>;
			remote-endpoint = <&dsi_in>;
		};
	};
};

&rtc {
	st,lsco = <RTC_OUT2_RMP>;
	pinctrl-0 = <&rtc_out2_rmp_pins_a>;
	pinctrl-names = "default";
};

/* Wifi */
&sdmmc2 {
	arm,primecell-periphid = <0x10153180>;
	pinctrl-names = "default", "opendrain", "sleep";
	pinctrl-0 = <&sdmmc2_b4_pins_a>;
	pinctrl-1 = <&sdmmc2_b4_od_pins_a>;
	pinctrl-2 = <&sdmmc2_b4_sleep_pins_a>;
	non-removable;
	st,neg-edge;
	bus-width = <4>;
	vmmc-supply = <&v3v3>;
	mmc-pwrseq = <&wifi_pwrseq>;
	#address-cells = <1>;
	#size-cells = <0>;
	status = "okay";

	brcmf: bcrmf@1 {
		reg = <1>;
		compatible = "brcm,bcm4329-fmac";
	};
};

/* Bluetooth */
&usart2 {
	pinctrl-names = "default", "sleep", "idle";
	pinctrl-0 = <&usart2_pins_c>;
	pinctrl-1 = <&usart2_sleep_pins_c>;
	pinctrl-2 = <&usart2_idle_pins_c>;
	uart-has-rtscts;
	status = "okay";

	bluetooth {
		shutdown-gpios = <&gpioz 6 GPIO_ACTIVE_HIGH>;
		compatible = "brcm,bcm43438-bt";
		max-speed = <3000000>;
		vbat-supply = <&v3v3>;
		vddio-supply = <&v3v3>;
	};
};
